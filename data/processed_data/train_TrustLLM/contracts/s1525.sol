function settleFunding() override external onlyClearingHouse { if (ammState != AMMState.Active) return; require(_blockTimestamp() >= nextFundingTime, "settle funding too early"); int256 underlyingPrice = getUnderlyingTwapPrice(spotPriceTwapInterval); int256 premium = getTwapPrice(spotPriceTwapInterval) - underlyingPrice; int256 premiumFraction = (premium * int256(fundingPeriod)) / 1 days; _updateFundingRate(premiumFraction, underlyingPrice); int256 premiumPerDtoken = posAccumulator * premiumFraction; premiumPerDtoken = (premiumPerDtoken / BASE_PRECISION) + 1; cumulativePremiumFraction += premiumFraction; cumulativePremiumPerDtoken += premiumPerDtoken; uint256 minNextValidFundingTime = _blockTimestamp() + fundingBufferPeriod; uint256 nextFundingTimeOnHourStart = ((nextFundingTime + fundingPeriod) / 1 hours) * 1 hours; nextFundingTime = nextFundingTimeOnHourStart > minNextValidFundingTime ? nextFundingTimeOnHourStart : minNextValidFundingTime; }
