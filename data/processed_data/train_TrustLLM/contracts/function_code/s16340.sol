function flashAction( IFlashAction receiver, uint256 collateralId, bytes calldata data ) external onlyOwner(collateralId) { address addr; uint256 tokenId; CollateralStorage storage s = _loadCollateralSlot(); (addr, tokenId) = getUnderlying(collateralId); if (!s.flashEnabled[addr]) { revert InvalidCollateralState(InvalidCollateralStates.FLASH_DISABLED); } if ( s.LIEN_TOKEN.getCollateralState(collateralId) == bytes32("ACTIVE_AUCTION") ) { revert InvalidCollateralState(InvalidCollateralStates.AUCTION_ACTIVE); } bytes32 preTransferState; address securityHook = s.securityHooks[addr]; if (securityHook != address(0)) { preTransferState = ISecurityHook(securityHook).getState(addr, tokenId); } ClearingHouse(s.clearingHouse[collateralId]).transferUnderlying( addr, tokenId, address(receiver) ); if ( receiver.onFlashAction( IFlashAction.Underlying(s.clearingHouse[collateralId], addr, tokenId), data ) != keccak256("FlashAction.onFlashAction") ) { revert FlashActionCallbackFailed(); } if ( securityHook != address(0) && preTransferState != ISecurityHook(securityHook).getState(addr, tokenId) ) { revert FlashActionSecurityCheckFailed(); } if ( IERC721(addr).ownerOf(tokenId) != address(s.clearingHouse[collateralId]) ) { revert FlashActionNFTNotReturned(); } }
